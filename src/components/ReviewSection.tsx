import React, { useState, useMemo } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Star, Plus, Filter, TrendingUp } from 'lucide-react';
import ReviewCard from './ReviewCard';
import WriteReviewModal from './WriteReviewModal';
import { useCreateReview, useDeleteReview, useUpdateReview } from '@/hooks/api/useReviews';
import { toast } from 'sonner';
import { apiService } from '@/services/api';
import { User, Review, UpdateReviewData } from '@/types';

interface ReviewSectionProps {
  fieldId: string; // Backend'de string ID kullanƒ±yoruz
  fieldName: string;
  rating: number;
  totalReviews: number;
  reviews: Review[];
  isLoggedIn?: boolean;
}

const ReviewSection = ({ 
  fieldId, 
  fieldName, 
  rating: averageRating, 
  totalReviews, 
  reviews: initialReviews,
  isLoggedIn = false 
}: ReviewSectionProps) => {
  const [reviews, setReviews] = useState(initialReviews);
  const [isWriteModalOpen, setIsWriteModalOpen] = useState(false);
  const [editingReview, setEditingReview] = useState<Review | null>(null);
  const [sortBy, setSortBy] = useState('newest');
  const [filterRating, setFilterRating] = useState('all');

  // Backend review hooks
  const createReviewMutation = useCreateReview();
  const deleteReviewMutation = useDeleteReview();
  const updateReviewMutation = useUpdateReview();

  // Debug: Log received reviews
  console.log('üé≠ ReviewSection received props:');
  console.log('  - fieldId:', fieldId);
  console.log('  - fieldName:', fieldName);
  console.log('  - averageRating:', averageRating);
  console.log('  - totalReviews:', totalReviews);
  console.log('  - initialReviews:', initialReviews);
  console.log('  - current reviews state:', reviews);

  // Calculate rating distribution
  const ratingDistribution = [5, 4, 3, 2, 1].map(rating => {
    const count = reviews.filter(review => review.rating === rating).length;
    const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
    return { rating, count, percentage };
  });

  const handleOpenWriteModal = () => {
    setEditingReview(null);
    setIsWriteModalOpen(true);
  };

  const handleOpenEditModal = (review: Review) => {
    setEditingReview(review);
    setIsWriteModalOpen(true);
  };

  const handleSubmitReview = async (data: { rating: number; comment: string }) => {
    if (editingReview) {
      // G√ºvenlik kontrol√º - kullanƒ±cƒ± giri≈ü yapmƒ±≈ü mƒ±?
      const currentUser = apiService.getCurrentUser();
      if (!currentUser) {
        toast.error("Yorum g√ºncellemek i√ßin giri≈ü yapmanƒ±z gerekiyor.");
        setIsWriteModalOpen(false);
        return;
      }

      // Sahiplik kontrol√º - bu kullanƒ±cƒ±nƒ±n yorumu mu?
      if (editingReview.userId !== currentUser.id) {
        toast.error("Sadece kendi yorumlarƒ±nƒ±zƒ± g√ºncelleyebilirsiniz.");
        setIsWriteModalOpen(false);
        return;
      }

      // WORKAROUND: Send all data the backend might require, to satisfy strict schema
      const updateData = {
        rating: data.rating,
        comment: data.comment,
        userId: editingReview.userId,
        haliSahaId: editingReview.haliSahaId
      };

      // Optional: Check if anything actually changed to avoid unnecessary API calls
      if (updateData.rating === editingReview.rating && updateData.comment === editingReview.comment) {
        toast.info("Yorumda bir deƒüi≈üiklik yapmadƒ±nƒ±z.");
        setIsWriteModalOpen(false);
        return;
      }

      try {
        await updateReviewMutation.mutateAsync({ reviewId: editingReview.id, data: updateData });
        // Optimistic update
        setReviews(prev => prev.map(r => r.id === editingReview.id ? { ...r, ...data } : r));
        toast.success("Yorum ba≈üarƒ±yla g√ºncellendi.");
      } catch (error: any) {
        const errorMessage = error?.message || error?.response?.data?.message || "Yorum g√ºncellenirken bir hata olu≈ütu.";
        toast.error(errorMessage);
        console.error("Update review error:", error.response?.data || error);
      }
    } else {
      // Create new review
      handleAddReview(data);
    }
    setIsWriteModalOpen(false);
  };

  const handleAddReview = async (newReview: { rating: number; comment: string }) => {
    console.log('üéØ handleAddReview called with:', newReview);
    console.log('üèüÔ∏è fieldId:', fieldId);
    
    // üîß TOKEN DEBUG - Detaylƒ± token kontrol√º
    console.log('=== TOKEN DEBUG START ===');
    const token = localStorage.getItem('token');
    console.log('1. Token exists:', !!token);
    console.log('2. Token preview:', token ? `${token.substring(0, 50)}...` : 'null');
    
    if (token) {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        console.log('3. Token payload:', payload);
        console.log('4. Payload keys:', Object.keys(payload));
        console.log('5. payload.id:', payload.id, 'type:', typeof payload.id);
        console.log('6. payload.userId:', payload.userId, 'type:', typeof payload.userId);
        console.log('7. payload.user?.id:', payload.user?.id, 'type:', typeof payload.user?.id);
        
        // Token expiry check
        if (payload.exp) {
          const now = Math.floor(Date.now() / 1000);
          const isExpired = payload.exp < now;
          console.log('8. Token exp:', payload.exp, 'now:', now, 'expired:', isExpired);
        }
      } catch (error) {
        console.error('‚ùå Token parse error:', error);
      }
    }
    console.log('=== TOKEN DEBUG END ===');
    
    if (!fieldId) {
      console.error('‚ùå Field ID is missing');
      toast.error('Halƒ± saha bilgisi eksik. Sayfayƒ± yenileyin.');
      return;
    }
    
    try {
      // Current user'ƒ± al
      const currentUser = apiService.getCurrentUser();
      console.log('üîç Current user from apiService:', currentUser);
      
      if (!currentUser) {
        console.error('‚ùå No current user found');
        toast.error('Kullanƒ±cƒ± bilgisi bulunamadƒ±. L√ºtfen tekrar giri≈ü yapƒ±n.');
        return;
      }
      
      if (!currentUser.id) {
        console.error('‚ùå User ID missing:', currentUser);
        toast.error('Kullanƒ±cƒ± ID bilgisi eksik. L√ºtfen tekrar giri≈ü yapƒ±n.');
        return;
      }

      const reviewData = {
        userId: currentUser.id,
        haliSahaId: fieldId,
        rating: parseInt(newReview.rating.toString()), // Backend Int bekliyor
        comment: newReview.comment.trim() // Bo≈üluklarƒ± temizle
      };
      
      console.log('üìã Final review data to send:', reviewData);
      console.log('üìã Review data types:', {
        userId: typeof reviewData.userId,
        haliSahaId: typeof reviewData.haliSahaId,
        rating: typeof reviewData.rating,
        comment: typeof reviewData.comment
      });
      
      // Validation kontrol√º (Backend Zod schema'ya g√∂re)
      if (!reviewData.comment || reviewData.comment.length < 1) {
        toast.error('Yorum bo≈ü olamaz.');
        return;
      }
      
      if (reviewData.rating < 1 || reviewData.rating > 5) {
        toast.error('Puan 1 ile 5 arasƒ±nda olmalƒ±.');
        return;
      }
      
      // UUID format kontrol√º
      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      if (!uuidRegex.test(reviewData.userId)) {
        console.error('‚ùå Invalid userId format:', reviewData.userId);
        toast.error('Kullanƒ±cƒ± ID formatƒ± ge√ßersiz.');
        return;
      }
      
      if (!uuidRegex.test(reviewData.haliSahaId)) {
        console.error('‚ùå Invalid haliSahaId format:', reviewData.haliSahaId);
        toast.error('Halƒ± saha ID formatƒ± ge√ßersiz.');
        return;
      }
      
      console.log('üì§ Sending review data:', reviewData);

      // Backend'e yorum g√∂nder
      const result = await createReviewMutation.mutateAsync(reviewData);
      console.log('‚úÖ Review creation result:', result);

      toast.success('Yorumunuz ba≈üarƒ±yla eklendi!');
      
      // Replace the part where it adds to local state with the new logic
      const tempReview: Review = {
        id: result.id,
        userId: result.userId,
        haliSahaId: result.haliSahaId,
        user: result.user?.name || currentUser.name,
        rating: result.rating,
        comment: result.comment,
        date: new Date(result.createdAt).toLocaleDateString('tr-TR'),
        avatar: `https://images.unsplash.com/photo-${Math.floor(Math.random() * 1000000000)}?w=40&h=40&fit=crop&crop=face`,
        helpful: 0,
        notHelpful: 0,
        verified: true
      };
      
      setReviews(prev => [tempReview, ...prev]);
    } catch (error: any) {
      console.error('‚ùå Review creation error:', error);
      
      // Detaylƒ± hata mesajƒ±
      let errorMessage = 'Yorum eklenirken bir hata olu≈ütu.';
      
      if (error?.response?.data?.message) {
        errorMessage = error.response.data.message;
      } else if (error?.message) {
        errorMessage = error.message;
      }
      
      console.error('Error details:', {
        message: error?.message,
        response: error?.response?.data,
        status: error?.response?.status
      });
      
      toast.error(errorMessage);
    }
  };

  const handleDelete = async (reviewId: string) => {
    // G√ºvenlik kontrol√º - kullanƒ±cƒ± giri≈ü yapmƒ±≈ü mƒ±?
    const currentUser = apiService.getCurrentUser();
    if (!currentUser) {
      toast.error("Yorum silmek i√ßin giri≈ü yapmanƒ±z gerekiyor.");
      return;
    }

    // Sahiplik kontrol√º - bu kullanƒ±cƒ±nƒ±n yorumu mu?
    const reviewToDelete = reviews.find(r => r.id === reviewId);
    if (!reviewToDelete) {
      toast.error("Silinecek yorum bulunamadƒ±.");
      return;
    }

    if (reviewToDelete.userId !== currentUser.id) {
      toast.error("Sadece kendi yorumlarƒ±nƒ±zƒ± silebilirsiniz.");
      return;
    }

    try {
      await deleteReviewMutation.mutateAsync(reviewId);
      setReviews(prev => prev.filter(review => review.id !== reviewId));
      toast.success("Yorum ba≈üarƒ±yla silindi.");
    } catch (error: any) {
      const errorMessage = error?.message || "Yorum silinirken bir hata olu≈ütu.";
      toast.error(errorMessage);
      console.error("Delete review error:", error);
    }
  };

  const handleHelpful = (reviewId: string) => {
    setReviews(prev => prev.map(review => 
      review.id === reviewId 
        ? { ...review, helpful: review.helpful + 1 }
        : review
    ));
  };

  const handleNotHelpful = (reviewId: string) => {
    setReviews(prev => prev.map(review => 
      review.id === reviewId 
        ? { ...review, notHelpful: review.notHelpful + 1 }
        : review
    ));
  };

  // Get current user for showing delete button
  const currentUser = apiService.getCurrentUser();

  // Filter and sort reviews
  const filteredAndSortedReviews = reviews
    .filter(review => filterRating === 'all' || review.rating.toString() === filterRating)
    .sort((a, b) => {
      switch (sortBy) {
        case 'newest':
          return new Date(b.date).getTime() - new Date(a.date).getTime();
        case 'oldest':
          return new Date(a.date).getTime() - new Date(b.date).getTime();
        case 'highest':
          return b.rating - a.rating;
        case 'lowest':
          return a.rating - b.rating;
        case 'helpful':
          return b.helpful - a.helpful;
        default:
          return 0;
      }
    });

  return (
    <div className="space-y-6">
      {/* Rating Overview */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center justify-between">
            <span>Deƒüerlendirmeler ve Yorumlar</span>
            {isLoggedIn && (
              <Button 
                onClick={handleOpenWriteModal}
                className="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700"
              >
                <Plus className="h-4 w-4 mr-2" />
                Yorum Yaz
              </Button>
            )}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid md:grid-cols-2 gap-8">
            {/* Overall Rating */}
            <div className="text-center">
              <div className="text-5xl font-bold text-gray-900 mb-2">{averageRating}</div>
              <div className="flex items-center justify-center gap-1 mb-2">
                {[...Array(5)].map((_, i) => (
                  <Star 
                    key={i} 
                    className={`h-6 w-6 ${i < Math.floor(averageRating) ? 'text-yellow-500 fill-current' : 'text-gray-300'}`} 
                  />
                ))}
              </div>
              <p className="text-gray-600">{totalReviews} deƒüerlendirme</p>
              <Badge variant="secondary" className="mt-2">
                <TrendingUp className="h-3 w-3 mr-1" />
                Son 30 g√ºnde +12 yorum
              </Badge>
            </div>

            {/* Rating Distribution */}
            <div className="space-y-3">
              {ratingDistribution.map(({ rating, count, percentage }) => (
                <div key={rating} className="flex items-center gap-3">
                  <div className="flex items-center gap-1 min-w-[60px]">
                    <span className="text-sm font-medium">{rating}</span>
                    <Star className="h-3 w-3 text-yellow-500 fill-current" />
                  </div>
                  <div className="flex-1 bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-gradient-to-r from-green-500 to-emerald-600 h-2 rounded-full transition-all duration-300"
                      style={{ width: `${percentage}%` }}
                    />
                  </div>
                  <span className="text-sm text-gray-600 min-w-[40px]">{count}</span>
                </div>
              ))}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Filters and Sorting */}
      <div className="flex flex-wrap items-center gap-4 p-4 bg-gray-50 rounded-lg">
        <div className="flex items-center gap-2">
          <Filter className="h-4 w-4 text-gray-600" />
          <span className="text-sm font-medium text-gray-700">Filtrele:</span>
        </div>
        <Select value={filterRating} onValueChange={setFilterRating}>
          <SelectTrigger className="w-32">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">T√ºm Puanlar</SelectItem>
            <SelectItem value="5">5 Yƒ±ldƒ±z</SelectItem>
            <SelectItem value="4">4 Yƒ±ldƒ±z</SelectItem>
            <SelectItem value="3">3 Yƒ±ldƒ±z</SelectItem>
            <SelectItem value="2">2 Yƒ±ldƒ±z</SelectItem>
            <SelectItem value="1">1 Yƒ±ldƒ±z</SelectItem>
          </SelectContent>
        </Select>
        
        <Select value={sortBy} onValueChange={setSortBy}>
          <SelectTrigger className="w-40">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="newest">En Yeni</SelectItem>
            <SelectItem value="oldest">En Eski</SelectItem>
            <SelectItem value="highest">En Y√ºksek Puan</SelectItem>
            <SelectItem value="lowest">En D√º≈ü√ºk Puan</SelectItem>
            <SelectItem value="helpful">En Faydalƒ±</SelectItem>
          </SelectContent>
        </Select>
        
        <Badge variant="outline" className="ml-auto">
          {filteredAndSortedReviews.length} yorum g√∂steriliyor
        </Badge>
      </div>

      {/* Reviews List */}
      <div className="space-y-4">
        {filteredAndSortedReviews.length > 0 ? (
          filteredAndSortedReviews.map((review) => (
            <ReviewCard
              key={review.id}
              review={review}
              currentUser={currentUser}
              onHelpful={handleHelpful}
              onNotHelpful={handleNotHelpful}
              onDelete={handleDelete}
              onEdit={handleOpenEditModal}
            />
          ))
        ) : (
          <Card>
            <CardContent className="text-center py-12">
              <Star className="h-12 w-12 text-gray-300 mx-auto mb-4" />
              <h3 className="text-lg font-medium text-gray-900 mb-2">
                Hen√ºz yorum bulunmuyor
              </h3>
              <p className="text-gray-600 mb-4">
                Bu saha hakkƒ±nda ilk yorumu siz yazƒ±n!
              </p>
              {isLoggedIn && (
                <Button 
                  onClick={handleOpenWriteModal}
                  className="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700"
                >
                  ƒ∞lk Yorumu Yaz
                </Button>
              )}
            </CardContent>
          </Card>
        )}
      </div>

      {/* Write Review Modal */}
      <WriteReviewModal
        isOpen={isWriteModalOpen}
        onClose={() => setIsWriteModalOpen(false)}
        onSubmit={handleSubmitReview}
        fieldName={fieldName}
        initialData={editingReview ? { rating: editingReview.rating, comment: editingReview.comment } : undefined}
      />
    </div>
  );
};

export default ReviewSection;
